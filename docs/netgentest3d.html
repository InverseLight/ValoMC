<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>

body {
	margin-top: 1cm;
	margin-left: 4cm;
	margin-right: 4cm;
	padding: 0;
        font-size: 15px;
        font-family: 'Roboto Condensed', 'Tahoma', 'Arial', sans-serif;
}

   ul.tree a {
    color: back;
    text-decoration: none;
    display: block;
    width: 100%;
   }
   ul.tree a:hover {
    background: lightgray;
    text-decoration: none;
    display: inline-block;
    width: 100%;
   }
img.logo {max-width: 300px;}

   li {
     list-style-type: none;
     background:  repeat-y;
     padding: 0;
   }


   ul.tree, ul.tree ul {
     list-style-type: none;
     background:  repeat-y;
     margin: 0;
     padding: 0;
     margin: 5px;
   }

   ul.tree ul {
     list-style-type: none;
     margin-left: 10px;
   }


a {
    color: black;
}

   ul.tree li {
     margin: 5px;
     padding: 0 12px;
     line-height: 20px;
     color: #369;
   }

   ul.tree li.last {
     background: #fff url(images/lastnode.png) no-repeat;
   }

ul.topnav {
    list-style-type: none;
    padding: 0;
    margin: 0;
    overflow: hidden;
    background-color: #333;
    font-size: 15px;
    text-align: center;
    width: 80vw;
}

ul.topnav li {float: left;}

ul.topnav li a {
    display: block;
    color: white;
    text-align: center;
    padding: 4px 27px;
    text-decoration: none;
}


ul.topnav li a:hover:not(.active) {background-color: #111;}
ul.topnav li a.active {background-color: #4CAF50;}
ul.topnav li.right {float: right;}
@media screen and (max-width: 600px){
    ul.topnav li.right, 
    ul.topnav li {float: none;}
}

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:80vw; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }

</style>
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML"></script>
</head>
<body> 
<img class="logo" src="ValoMC_logo.png">
<ul class="topnav">
<font size="4">
  <li><a href="index.html">Home</a></li>
  <li><a href="download.html">Download</a></li>
  <li><a href="features.html">Features</a></li>
  <li><a href="installation.html">Installation</a></li>
  <li><a class="active" href="documentation.html">Documentation</a></li>
  <li class="right"><a href="about.html">About</a></li>
</font>
</ul>

<div style="padding:0 16px;">
  <h2></h2>
  <p></p>
  <p></p>
<font size="4">
<div style="width: 100%;">
    <div style="width: 300px; float: left;">
<br> 
<li><a>Documentation</a></li>
<ul class="tree">
<li><a href="gettingstarted.html">Getting started</a></li>
<li><a>2D</a></li>
<ul class="tree">
<li><a href="simpletest.html">Simple example</a></li>
<li><a href="inhomogeneous.html">Creating an inhomogeneous medium</a></li>
<li><a href="directingls.html">Directing light sources</a></li>
<li><a href="boundarytest.html">Setting boundary conditions and visualising the boundary solution</a></li>
<li><a href="frequency.html">Frequency domain calculation</a></li>
<li><a href="netgentest.html">Working with NetGen</a></li>
<li><a href="generatingc.html">Generating input for the external executable</a></li>
<li><a href="pixeltest.html">Working with pixel format data</a></li>
<li><a href="kwavetest.html">Simulating the photoacoustic effect using K-Wave</a></li>
<li><a>Code documentation</a></li>
<ul class="tree">
<li><a href="structures.html">List of structures</a></li>
<li><a href="findingelements.html">Finding elements</a></li>
<li><a href="findingboundaries.html">Finding boundaries</a></li>
</ul></ul>
<li><a>3D</a></li>
<ul class="tree">
<li><a href="voxeltest.html">Working with voxel format data</a></li>
<li><a href="netgentest3d.html">Working with NetGen</a></li>
<li><a href="threedmodel.html">Digimouse example</a></li>
<li><a>Code documentation</a></li>
<ul class="tree">
<li><a href="structures3d.html">List of structures</a></li>
<li><a href="findingelements3d.html">Finding elements</a></li>
<li><a href="findingboundaries3d.html">Finding boundaries</a></li>
</ul></ul>
<li><a href="literature.html">Literature</a></li>
<li><a href="functionreference.html">Alphabetical function listing</a></li>
</ul>
    </div>
    <div style="margin-left: 350px; padding: 5px;"> 
<div class="content"><h1>Netgen 3D example</h1><!--introduction--><p>This example demonstrates how to setup a 3D simulation on a geometry built with Netgen and run it. The geometry is a sphere within a cube. The sphere has a different refractive index than the cube. The mesh is created so that there is a circular domain within one surface of the cube.  You can view the Netgen Python source code <a href="netgen_box_with_sphere.py">here</a></p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Import the NetGen file</a></li><li><a href="#2">Remove incompatible boundaries from the mesh</a></li><li><a href="#3">Set constant background coefficients</a></li><li><a href="#4">Find boundary elements from Netgen file</a></li><li><a href="#5">Plot the Netgen mesh</a></li><li><a href="#6">Setup lightsources and optical coefficients</a></li><li><a href="#7">Run the simulation</a></li><li><a href="#8">Visualize the solution</a></li></ul></div><h2 id="1">Import the NetGen file</h2><pre class="codeinput">clear <span class="string">all</span>;

<span class="keyword">if</span>(exist(<span class="string">'box_with_sphere.vol'</span>, <span class="string">'file'</span>) ~= 2)
    error(<span class="string">'Could not find the mesh data file. Please run netgen netgen_box_with_sphere.py'</span>);
<span class="keyword">end</span>

[vmcmesh regions region_names boundaries boundary_names] = importNetGenMesh(<span class="string">'box_with_sphere.vol'</span>);
</pre><h2 id="2">Remove incompatible boundaries from the mesh</h2><p>Note that boundary 7 (sphere surface) is located within the medium, so it must be removed (see Netgen example in 2d). However, before removing it, the sphere surface  can be used to find the elements within the sphere</p><pre class="codeinput">elements_of_the_sphere = findElements(vmcmesh, <span class="string">'region'</span>, vmcmesh.BH(cell2mat(boundaries(7)))); <span class="comment">% store the indices of the elements within the sphere surface</span>
vmcmesh.BH(cell2mat(boundaries(7)),:) = [];
boundaries(7) = [];

<span class="comment">% 0.1 is to make the search area slightly larger than the cylinder</span>
<span class="comment">% that was used to create the lightsource (c.f. fincyl in the Netgen</span>
<span class="comment">% source) to make sure all the boundary elements are contained.</span>
</pre><h2 id="3">Set constant background coefficients</h2><pre class="codeinput">vmcmedium.absorption_coefficient = 0.01;     <span class="comment">% absorption coefficient [1/mm]</span>
vmcmedium.scattering_coefficient = 0.01;     <span class="comment">% scattering coefficient [1/mm]</span>
vmcmedium.scattering_anisotropy = 0.9;       <span class="comment">% anisotropy parameter g of</span>
                                             <span class="comment">% the Heneye-Greenstein scattering</span>
                                             <span class="comment">% phase function [unitless]</span>
vmcmedium.refractive_index = 1.0;            <span class="comment">% refractive index [unitless]</span>
vmcmedium = createMedium(vmcmesh, vmcmedium);
</pre><h2 id="4">Find boundary elements from Netgen file</h2><p>Note that surfaces part of a planar region cannot be currently given separate boundary condition in netgen. However, we can use findBoundaries to find the place for the light source from the mesh.</p><pre class="codeinput">startpoint = [0 0 0 ]; <span class="comment">% note that these are exactly the same</span>
waypoint = [-5 0 0];   <span class="comment">% coordinates as in the netgen source file</span>
radius = 1.0;          <span class="comment">% that are used to define a cylinder that creates a domain in the plane</span>
elements_of_the_lightsource = findBoundaries(vmcmesh, <span class="string">'direction'</span>, startpoint, waypoint, radius+0.1);
</pre><h2 id="5">Plot the Netgen mesh</h2><pre class="codeinput">figure

trimesh(vmcmesh.BH(cell2mat(boundaries(:)),:),vmcmesh.r(:,1),vmcmesh.r(:,2),vmcmesh.r(:,3),<span class="string">'facecolor'</span>, <span class="string">'r'</span>,<span class="string">'FaceAlpha'</span>,0.2);
hold

<span class="comment">% Highlight the location for the lightsource for the plot</span>
trimesh(vmcmesh.BH(elements_of_the_lightsource,:),vmcmesh.r(:,1), <span class="keyword">...</span>
        vmcmesh.r(:,2),vmcmesh.r(:,3),<span class="string">'facecolor'</span>, <span class="string">'b'</span>);

<span class="comment">% Show the sphere</span>
tetramesh(vmcmesh.H(elements_of_the_sphere,:), vmcmesh.r);


xlabel(<span class="string">'x [mm]'</span>);
ylabel(<span class="string">'y [mm]'</span>);
zlabel(<span class="string">'z [mm]'</span>);
hold <span class="string">off</span>
</pre><pre class="codeoutput">Current plot held
</pre><img alt="" hspace="5" src="netgentest3d_01.png" vspace="5"/> <h2 id="6">Setup lightsources and optical coefficients</h2><p>the elements within the sphere are used to set up region of higher refractive index</p><pre class="codeinput">vmcmedium.refractive_index(elements_of_the_sphere) = 1.7;
vmcboundary = createBoundary(vmcmesh, vmcmedium);
vmcboundary.lightsource(elements_of_the_lightsource) = {<span class="string">'direct'</span>};
</pre><h2 id="7">Run the simulation</h2><pre class="codeinput">solution = ValoMC(vmcmesh, vmcmedium, vmcboundary);
</pre><pre class="codeoutput">Initializing MC3D...
Computation uses 16 threads
Computing... 
...done

Done
</pre><h2 id="8">Visualize the solution</h2><p>Note how sphere acts as a lens</p><pre class="codeinput">halfspace_elements = findElements(vmcmesh, <span class="string">'halfspace'</span>, [0 0 0], [0 1 0]);
figure
tetramesh(vmcmesh.H(halfspace_elements,:), vmcmesh.r, solution.element_fluence(halfspace_elements));
view(-10,10);
<span class="comment">%</span>
<span class="comment">%hold</span>
xlabel(<span class="string">'x [mm]'</span>);
ylabel(<span class="string">'y [mm]'</span>);
zlabel(<span class="string">'z [mm]'</span>);
</pre><img alt="" hspace="5" src="netgentest3d_02.png" vspace="5"/> <p class="footer"><br/><a href="http://www.mathworks.com/products/matlab/">Published with MATLABÂ® R2016b</a><br/></p></div>
    </div>
</div>
</font>

  </div>

<br>
<br> </div><footer> <hr> <p>Last updated: Tue May 29 01:57:59 EEST 2018 by aleksle</p></footer> </body> </html>

